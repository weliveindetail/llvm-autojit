#!/usr/bin/env bash

clang="clang"
CFLAGS="-O0 -g -fpass-plugin=@CMAKE_INSTALL_PREFIX@/lib/autojit.so"

if [ "$AUTOJIT_LINK_STATIC_RUNTIME" = "On" ]; then
  # FIXME: Make arch generic, right now it's specific for Intel
  LDFLAGS="-L@CMAKE_INSTALL_PREFIX@/lib -Wl,--whole-archive -lautojit_static-x86_64 -Wl,--no-whole-archive -rdynamic"
else
  LDFLAGS="-Wl,-rpath=@CMAKE_INSTALL_PREFIX@/lib -L@CMAKE_INSTALL_PREFIX@/lib -lautojit-runtime -rdynamic"
fi

if [ "@AUTOJIT_BUILD_UNIFIED@" = "On" ]; then
  # Use the just-built compiler and linker
  LDFLAGS="$LDFLAGS -fuse-ld=lld -B@CMAKE_INSTALL_PREFIX@/bin"
  clang="@CMAKE_INSTALL_PREFIX@/bin/clang"
fi

cd bzip2/$AUTOJIT_BUILD_DIR
make CC="$clang" CXX="$clang++" CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS"
